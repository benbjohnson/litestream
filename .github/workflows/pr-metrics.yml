name: PR Build Metrics

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-base:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache base binary
        id: cache-base
        uses: actions/cache@v4
        with:
          path: litestream-base
          key: pr-metrics-base-${{ github.event.pull_request.base.sha }}

      - name: Build base binary
        if: steps.cache-base.outputs.cache-hit != 'true'
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o litestream-base ./cmd/litestream

      - name: Record base binary size
        run: stat --format=%s litestream-base > base-size.txt

      - name: Upload base size
        uses: actions/upload-artifact@v4
        with:
          name: base-size
          path: base-size.txt

  build-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build PR binary
        run: |
          START=$SECONDS
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o litestream-pr ./cmd/litestream
          echo "$((SECONDS - START))" > build-time.txt
          go version | awk '{print $3}' > go-version.txt

      - name: Record PR binary size
        run: stat --format=%s litestream-pr > pr-size.txt

      - name: Upload PR size
        uses: actions/upload-artifact@v4
        with:
          name: pr-size
          path: pr-size.txt

      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: |
            build-time.txt
            go-version.txt

  analyze-deps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: pr/go.mod

      - name: Diff go.mod dependencies
        run: |
          diff_deps() {
            local gomod="$1"
            grep -E '^\t' "$gomod" | sed 's/^\t//' | sort
          }
          diff_deps base/go.mod > /tmp/base-deps.txt
          diff_deps pr/go.mod > /tmp/pr-deps.txt

          echo "## Added" > deps-diff.txt
          comm -13 /tmp/base-deps.txt /tmp/pr-deps.txt >> deps-diff.txt
          echo "## Removed" >> deps-diff.txt
          comm -23 /tmp/base-deps.txt /tmp/pr-deps.txt >> deps-diff.txt

      - name: Module graph size
        run: |
          cd base && go mod graph | wc -l | tr -d ' ' > ../base-graph-size.txt && cd ..
          cd pr && go mod graph | wc -l | tr -d ' ' > ../pr-graph-size.txt && cd ..

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          cd pr
          govulncheck ./... > ../vulncheck-results.txt 2>&1 || true

      - name: Upload dependency analysis
        uses: actions/upload-artifact@v4
        with:
          name: dep-analysis
          path: |
            deps-diff.txt
            base-graph-size.txt
            pr-graph-size.txt
            vulncheck-results.txt

  post-comment:
    runs-on: ubuntu-latest
    needs: [build-base, build-pr, analyze-deps]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const baseSize = parseInt(fs.readFileSync('base-size/base-size.txt', 'utf8').trim());
            const prSize = parseInt(fs.readFileSync('pr-size/pr-size.txt', 'utf8').trim());
            const buildTime = fs.readFileSync('build-info/build-time.txt', 'utf8').trim();
            const goVersion = fs.readFileSync('build-info/go-version.txt', 'utf8').trim();
            const depsDiff = fs.readFileSync('dep-analysis/deps-diff.txt', 'utf8').trim();
            const baseGraphSize = fs.readFileSync('dep-analysis/base-graph-size.txt', 'utf8').trim();
            const prGraphSize = fs.readFileSync('dep-analysis/pr-graph-size.txt', 'utf8').trim();
            const vulncheck = fs.readFileSync('dep-analysis/vulncheck-results.txt', 'utf8').trim();

            const diff = prSize - baseSize;
            const pct = baseSize > 0 ? ((diff / baseSize) * 100).toFixed(2) : 'N/A';
            const arrow = diff > 0 ? 'ðŸ“ˆ' : diff < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
            const sign = diff > 0 ? '+' : '';
            const fmt = (bytes) => (bytes / 1024 / 1024).toFixed(2) + ' MB';

            const addedLines = depsDiff.split('\n').filter(l => l && !l.startsWith('##'));
            const addedSection = depsDiff.split('## Removed')[0].replace('## Added', '').trim();
            const removedSection = depsDiff.split('## Removed')[1]?.trim() || '';
            const addedDeps = addedSection ? addedSection.split('\n').filter(l => l.trim()) : [];
            const removedDeps = removedSection ? removedSection.split('\n').filter(l => l.trim()) : [];

            let depsTable = '';
            if (addedDeps.length > 0 || removedDeps.length > 0) {
              depsTable = '### Dependency Changes\n\n';
              if (addedDeps.length > 0) {
                depsTable += '**Added:**\n' + addedDeps.map(d => `- \`${d}\``).join('\n') + '\n\n';
              }
              if (removedDeps.length > 0) {
                depsTable += '**Removed:**\n' + removedDeps.map(d => `- \`${d}\``).join('\n') + '\n\n';
              }
            } else {
              depsTable = '### Dependency Changes\n\nNo dependency changes.\n\n';
            }

            const graphDiff = parseInt(prGraphSize) - parseInt(baseGraphSize);
            const graphSign = graphDiff > 0 ? '+' : '';

            const body = `## PR Build Metrics

            ### Binary Size (linux/amd64)

            | | Size | Change |
            |---|---:|---:|
            | Base (\`${context.payload.pull_request.base.sha.substring(0, 7)}\`) | ${fmt(baseSize)} | |
            | PR (\`${context.sha.substring(0, 7)}\`) | ${fmt(prSize)} | ${arrow} ${sign}${(diff / 1024).toFixed(1)} KB (${sign}${pct}%) |

            ${depsTable}
            ### Module Graph

            | | Edges |
            |---|---:|
            | Base | ${baseGraphSize} |
            | PR | ${prGraphSize} (${graphSign}${graphDiff}) |

            ### Vulnerability Check

            <details>
            <summary>govulncheck results</summary>

            \`\`\`
            ${vulncheck}
            \`\`\`

            </details>

            ### Build Info

            | Metric | Value |
            |---|---|
            | Build time | ${buildTime}s |
            | Go version | \`${goVersion}\` |
            | Commit | \`${context.sha.substring(0, 7)}\` |

            ---
            <sub>ðŸ¤– This comment is automatically updated on each push.</sub>`.replace(/^            /gm, '');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## PR Build Metrics';
            const existing = comments.find(c => c.body?.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
