# S3 Configuration

AWS S3 and S3-compatible storage backends.

## Quick Start

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://my-bucket/backups/app
```

## URL Format

```
s3://BUCKET/PATH[?endpoint=HOST&region=REGION&...]
```

## AWS S3

### Using Environment Variables (Recommended)

```bash
export AWS_ACCESS_KEY_ID=AKIA...
export AWS_SECRET_ACCESS_KEY=...
export AWS_REGION=us-east-1
```

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://my-bucket/app-backup
```

### Using Config File

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://my-bucket/app-backup
      access-key-id: ${AWS_ACCESS_KEY_ID}
      secret-access-key: ${AWS_SECRET_ACCESS_KEY}
      region: us-east-1
```

### Using IAM Roles (EC2/ECS/Lambda)

No credentials needed - uses instance profile:

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://my-bucket/app-backup
      region: us-east-1
```

### Using S3 Access Points (ARN)

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://arn:aws:s3:us-east-1:123456789012:accesspoint/my-access-point/backups
```

## S3-Compatible Providers

### Cloudflare R2

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://bucket/path?endpoint=ACCOUNT_ID.r2.cloudflarestorage.com
      access-key-id: ${R2_ACCESS_KEY_ID}
      secret-access-key: ${R2_SECRET_ACCESS_KEY}
```

### Fly.io Tigris

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://bucket/path?endpoint=fly.storage.tigris.dev&region=auto
      access-key-id: ${AWS_ACCESS_KEY_ID}
      secret-access-key: ${AWS_SECRET_ACCESS_KEY}
```

Tigris auto-configures signing and Content-MD5 requirements.

### DigitalOcean Spaces

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://bucket/path?endpoint=nyc3.digitaloceanspaces.com&region=nyc3
      access-key-id: ${DO_SPACES_KEY}
      secret-access-key: ${DO_SPACES_SECRET}
```

### Backblaze B2

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://bucket/path?endpoint=s3.us-west-000.backblazeb2.com&region=us-west-000
      access-key-id: ${B2_KEY_ID}
      secret-access-key: ${B2_APPLICATION_KEY}
```

### MinIO

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://bucket/path?endpoint=localhost:9000&skipVerify=true
      access-key-id: minioadmin
      secret-access-key: minioadmin
```

### Scaleway Object Storage

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://bucket/path?endpoint=s3.fr-par.scw.cloud&region=fr-par
      access-key-id: ${SCW_ACCESS_KEY}
      secret-access-key: ${SCW_SECRET_KEY}
```

### Filebase

```yaml
dbs:
  - path: /data/app.db
    replica:
      url: s3://bucket/path?endpoint=s3.filebase.com
      access-key-id: ${FILEBASE_ACCESS_KEY}
      secret-access-key: ${FILEBASE_SECRET_KEY}
```

## Configuration Options

| Option | Default | Description |
|--------|---------|-------------|
| `access-key-id` | - | AWS access key |
| `secret-access-key` | - | AWS secret key |
| `region` | us-east-1 | AWS region |
| `bucket` | - | S3 bucket name |
| `endpoint` | - | Custom S3 endpoint |
| `force-path-style` | auto | Use path-style URLs |
| `sign-payload` | true | Sign request payloads |
| `require-content-md5` | true | Require Content-MD5 header |
| `skip-verify` | false | Skip TLS verification |
| `part-size` | 5MB | Multipart upload part size |
| `concurrency` | 5 | Upload concurrency |

## Server-Side Encryption

### SSE-S3 (AWS Managed Keys)

Enabled by default on bucket - no configuration needed.

### SSE-KMS (AWS KMS)

```yaml
replica:
  url: s3://bucket/path
  sse-kms-key-id: arn:aws:kms:us-east-1:123456789012:key/12345678-1234-...
```

### SSE-C (Customer Provided Keys)

```yaml
replica:
  url: s3://bucket/path
  sse-customer-algorithm: AES256
  sse-customer-key: ${SSE_CUSTOMER_KEY}
  # OR from file:
  sse-customer-key-path: /etc/litestream/sse-key
```

## URL Query Parameters

| Parameter | Description |
|-----------|-------------|
| `endpoint` | Custom S3 endpoint |
| `region` | Override region |
| `forcePathStyle` | true/false for path-style URLs |
| `skipVerify` | true/false for TLS verification |
| `signPayload` | true/false for payload signing |
| `requireContentMD5` | true/false for Content-MD5 |

Example:
```
s3://bucket/path?endpoint=minio:9000&skipVerify=true&forcePathStyle=true
```

## IAM Policy

Minimum required permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::my-bucket",
        "arn:aws:s3:::my-bucket/*"
      ]
    }
  ]
}
```

## Troubleshooting

### "Access Denied"
- Verify IAM permissions include all required actions
- Check bucket policy allows access
- Ensure region is correct

### "Bucket not found"
- Verify bucket name is correct
- Check region matches bucket location

### "Connection refused" (custom endpoint)
- Verify endpoint URL is correct
- Check `skipVerify=true` for self-signed certs
- Ensure `forcePathStyle=true` for most S3-compatible providers

### Slow uploads
- Increase `part-size` for large databases
- Increase `concurrency` for faster uploads
- Check network connectivity to endpoint
